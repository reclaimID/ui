<div *ngIf="actions !== ''" class="alert alert-primary fade show" style="position:fixed;top:0; width:100%;z-index:100;">
  <i class="fa fa-spinner fa-spin" aria-hidden="true"></i> {{actions}}
</div>

<!-- Identity edit screen -->
<div class="m-2 card">
  <div class="card-avatar card-img-top">
    <div class="card-avatar-character text-dark">
      <h2 class="fa-2x"><i class="fa fa-user-circle pr-2"></i> {{ identity.name }}</h2>
    </div>
  </div>
  <!--IdProvider-Discovery-->
  <div *ngIf="!hasAttributes()" class="alert alert-primary alert-dismissible fade show my-2" role="alert" >
    <span class="fa fa-info"> </span>  <b class="ml-2">{{getMessage("edit_identity_html@noAttributes")}}</b><br/>
    {{getMessage("edit_identity_html@importInfo")}}<br/>
    <button class="btn btn-primary" [routerLink]="['/import-attributes', identity.name ]">
      <span class="fa fa-download"></span> {{getMessage("edit_identity_html@linkAccount")}}
    </button>
  </div>

  <!-- Attribute table -->
  <div class="card-body">
    <div>
      <h3 class="card-subtitle mb-2"> {{getMessage("edit_identity_html@basicInfo")}} <span (click)="showGeneralInfo = !showGeneralInfo" class="fa fa-question-circle"></span></h3>
      <div class="alert alert-secondary fade show" *ngIf="showGeneralInfo" >
        {{getMessage("edit_identity_html@standardScopes")}}
      </div>

      <div class="table pb-1">
          <!-- Standard "profile" claims first -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of existingProfileClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b>
              </div>
            </div>
            <div class="col-sm">
              <input *ngIf="!isClaimCred(claim) && (claim == claimInEdit)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">{{ claim.value }} <i class="text-secondary" style="float:right;"><i class="fa fa-certificate"></i> Self-issued</i></span>
              <span *ngIf="isClaimCred(claim)"  >{{ getCredValue(claim) }} <i class="text-primary" style="float:right;"><i class="fa fa-certificate"></i> {{ getIssuer(claim) }}</i></span>
            </div>
            <div class="col-sm">
              <button class="btn btn-primary"  (click)="deleteAttribute(claim)">
                <span class="fa fa-trash"></span>
              </button>
              <button class="ml-1 btn btn-primary" (click)="editAttribute(claim)" *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">
                <span class="fa fa-edit"></span>
              </button>
            </div>
          </div>
          <!-- Standard "profile" claims missing on the identity -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of missingProfileClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b></div></div>
            <div class="col-sm">
              <!-- FIXME Allow adding of credential OR plain value -->
              <input *ngIf="claim == claimInEdit" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="claim != claimInEdit"><i class="text-secondary">Unset</i></span>
              <!--<input *ngIf="!isClaimCred(claim)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="isClaimCred(claim)" >{{ getCredValue(claim) }} issued by <i>{{ getIssuer(claim) }}</i> as attribute for ``{{ claim.value }}''</span>-->
            </div>
            <div class="col-sm">
              <button *ngIf="claim == claimInEdit" [disabled]="!canAddAttribute(claim)" class="btn btn-primary"  (click)="addAttribute()">
                <span class="fa fa-save"></span>
              </button>
              <button *ngIf="claim != claimInEdit" class="btn btn-primary"  (click)="editAttribute(claim)">
                <span class="fa fa-plus"></span>
              </button>
            </div>
          </div>
      </div>
      <div class="table pb-1">
          <!-- Standard "email" claims first -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of existingEmailClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b></div></div>
            <div class="col-sm">
              <input *ngIf="!isClaimCred(claim) && (claim == claimInEdit)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">{{ claim.value }} <i class="text-secondary" style="float:right;"><i class="fa fa-certificate"></i> Self-issued</i></span>
              <span *ngIf="isClaimCred(claim)"  >{{ getCredValue(claim) }} <i class="text-primary" style="float:right;"><i class="fa fa-certificate"></i> {{ getIssuer(claim) }}</i></span>
            </div>
            <div class="col-sm">
              <button class="btn btn-primary"  (click)="deleteAttribute(claim)">
                <span class="fa fa-trash"></span>
              </button>
              <button class="ml-1 btn btn-primary" (click)="editAttribute(claim)" *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">
                <span class="fa fa-edit"></span>
              </button>
            </div>
          </div>
          <!-- Standard "email" claims missing on the identity -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of missingEmailClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b></div></div>
            <div class="col-sm">
              <!-- FIXME Allow adding of credential OR plain value -->
              <input *ngIf="claim == claimInEdit" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="claim != claimInEdit"><i class="text-secondary">Unset</i></span>
              <!--<input *ngIf="!isClaimCred(claim)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="isClaimCred(claim)" >{{ getCredValue(claim) }} issued by <i>{{ getIssuer(claim) }}</i> as attribute for ``{{ claim.value }}''</span>-->
            </div>
            <div class="col-sm">
              <button *ngIf="claim == claimInEdit" [disabled]="!canAddAttribute(claim)" class="btn btn-primary"  (click)="addAttribute()">
                <span class="fa fa-save"></span>
              </button>
              <button *ngIf="claim != claimInEdit" class="btn btn-primary"  (click)="editAttribute(claim)">
                <span class="fa fa-plus"></span>
              </button>
            </div>
          </div>
      </div>


      <div class="table pb-1">
          <!-- Standard "address" claims first -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of existingAddressClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b></div></div>
            <div class="col-sm">
              <input *ngIf="!isClaimCred(claim) && (claim == claimInEdit)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">{{ claim.value }} <i class="text-secondary" style="float:right;"><i class="fa fa-certificate"></i> Self-issued</i></span>
              <span *ngIf="isClaimCred(claim)"  >{{ getCredValue(claim) }} <i class="text-primary" style="float:right;"><i class="fa fa-certificate"></i> {{ getIssuer(claim) }}</i></span>
            </div>
            <div class="col-sm">
              <button class="btn btn-primary"  (click)="deleteAttribute(claim)">
                <span class="fa fa-trash"></span>
              </button>
              <button class="ml-1 btn btn-primary" (click)="editAttribute(claim)" *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">
                <span class="fa fa-edit"></span>
              </button>

            </div>
          </div>
          <!-- Standard "profile" claims missing on the identity -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of missingAddressClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b></div></div>
            <div class="col-sm">
              <!-- FIXME Allow adding of credential OR plain value -->
              <input *ngIf="claim == claimInEdit" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="claim != claimInEdit"><i class="text-secondary">Unset</i></span>
              <!--<input *ngIf="!isClaimCred(claim)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="isClaimCred(claim)" >{{ getCredValue(claim) }} issued by <i>{{ getIssuer(claim) }}</i> as attribute for ``{{ claim.value }}''</span>-->
            </div>
            <div class="col-sm">
              <button *ngIf="claim == claimInEdit" [disabled]="!canAddAttribute(claim)" class="btn btn-primary"  (click)="addAttribute()">
                <span class="fa fa-save"></span>
              </button>
              <button *ngIf="claim != claimInEdit" class="btn btn-primary"  (click)="editAttribute(claim)">
                <span class="fa fa-plus"></span>
              </button>
            </div>
          </div>
      </div>

      <div class="table pb-1">
          <!-- Standard "phone" claims first -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of existingPhoneClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b></div></div>
            <div class="col-sm">
              <input *ngIf="!isClaimCred(claim) && (claim == claimInEdit)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">{{ claim.value }} <i class="text-secondary" style="float:right;"><i class="fa fa-certificate"></i> Self-issued</i></span>
              <span *ngIf="isClaimCred(claim)"  >{{ getCredValue(claim) }} <i class="text-primary" style="float:right;"><i class="fa fa-certificate"></i> {{ getIssuer(claim) }}</i></span>
            </div>
            <div class="col-sm">
              <button class="btn btn-primary"  (click)="deleteAttribute(claim)">
                <span class="fa fa-trash"></span>
              </button>
              <button class="ml-1 btn btn-primary" (click)="editAttribute(claim)" *ngIf="!isClaimCred(claim) && (claim != claimInEdit)">
                <span class="fa fa-edit"></span>
              </button>

            </div>
          </div>
          <!-- Standard "phone" claims missing on the identity -->
          <div class="row mb-3" [class.openid]="inOpenIdFlow()"
              [class.text-primary]="isClaimRequested(claim) || claim == claimInEdit"
              [class.alert-danger]="newAttribute.name === claim.name"
              *ngFor="let claim of missingPhoneClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(claim)" class="fa fa-openid"></i><b> {{ getDescription(claim) }}</b></div></div>
            <div class="col-sm">
              <div *ngIf="claim == claimInEdit && isExperimental()" name="newAttribute">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="claim" [(ngModel)]="claim.flag" (click)="claim.value=''" id="plainClaim" value="0" checked>
                  <label class="form-check-label" for="plainClaim">
                    {{ getMessage("edit_identity_html@plain") }}
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="claim" (click)="claim.value=''" [(ngModel)]="claim.flag" id="credentialClaim" value="1">
                  <label class="form-check-label" for="credentialClaim">
                    {{ getMessage("edit_identity_html@credential") }}
                  </label>
                </div>
              </div>
              <input *ngIf="claim == claimInEdit && claim.flag == '0'" placeholder="{{ getMessage('Value') }}" [(ngModel)]="claim.value">
              <span *ngIf="claim != claimInEdit"><i class="text-secondary">Unset</i></span>
              <select *ngIf="claim == claimInEdit && claim.flag == '1' && hasCredentialSources()" class="custom-select"
                (change)="claim.credential=$event.target.value; " >
                <option value="">{{ getMessage("edit_identity_html@selectSource") }}</option>
                <option *ngFor="let cred of credentials" value={{cred.id}}>
                {{cred.name}}
                </option>
              </select>
              <div *ngIf="claim.flag == '1' && !hasCredentialSources()" class="alert alert-primary" role="alert">
                {{ getMessage("edit_identity_html@noCredentialSource") }}
              </div>

              <select class="custom-select"
                *ngIf="(claim.credential !== '') && (claim.flag == '1')" (change)="claim.value=$event.target.value">
                <option value="">{{ getMessage("edit_identity_html@selectClaim") }}</option>
                <option *ngFor="let att of credentialValuesForClaim(claim)" value={{att.name}}>
                {{att.value}} <i>({{att.name}})</i>
                </option>
              </select>

            </div>
            <div class="col-sm">
              <button *ngIf="claim == claimInEdit" [disabled]="!canAddAttribute(claim)" class="btn btn-primary"  (click)="addAttribute()">
                <span class="fa fa-save"></span>
              </button>
              <button *ngIf="claim != claimInEdit" class="btn btn-primary"  (click)="editAttribute(claim)">
                <span class="fa fa-plus"></span>
              </button>
            </div>
          </div>
      </div>


      <h3 class="card-subtitle mb-2" >{{ getMessage("edit_identity_html@additionalInfo") }} <span (click)="showExtraInfo = !showExtraInfo" class="fa fa-question-circle"></span></h3>
      <div class="alert alert-secondary fade show" *ngIf="showExtraInfo" >
        {{ getMessage("edit_identity_html@non_standardClaims") }}
      </div>

      <!-- Missing "non-standard" claims that are requested -->
      <div class="table pb-1" *ngIf="isAnyRequestedNonStandardClaimMissing()">
          <div class="row mb-3 text-primary"
            [class.openid]="inOpenIdFlow()"
            [class.text-primary]="missing == claimInEdit"
            [class.alert-danger]="newAttribute.name === missing.name"
            *ngFor="let missing of missingNonStandardClaims">
            <div class="col-sm"><div style="min-width: 15em">
                <i *ngIf="isClaimRequested(missing)" class="fa fa-openid"></i><b> {{missing.name}}</b></div></div>
            <div class="col-sm">
              <input *ngIf="!isClaimCredentialRequested(missing)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="missing.value">
              <select *ngIf="isClaimCredentialRequested(missing) && hasCredentialSources()" class="custom-select" (change)="missing.credential=$event.target.value; ">
                <option value="">{{ getMessage("edit_identity_html@selectSource") }}</option>
                <option *ngFor="let cred of credentials" value={{cred.id}}>
                  {{cred.name}}
                </option>
              </select>
              <div *ngIf="isClaimCredentialRequested(missing) && !hasCredentialSources()" class="alert alert-primary" role="alert">
                {{ getMessage("edit_identity_html@noCredentialSource") }}
              </div>

              <select *ngIf="isClaimCredentialRequested(missing) && missing.credential !== ''" class="custom-select" (change)="missing.value=$event.target.value">
                <option value="">{{ getMessage("edit_identity_html@selectClaim") }}</option>
                <option *ngFor="let claim of credentialValuesForClaim(missing)" value={{claim.name}}>
                  {{claim.value}} <i>({{claim.name}})</i>
                </option>
              </select>
            </div>
            <div class="col-sm">
            </div>
          </div>
      </div>
      <!-- "non-standard" claims which do exist -->
      <div class="table pb-1">
          <div class="row mb-3"
            [class.openid]="inOpenIdFlow()"
            [class.text-primary]="isClaimRequested(attribute) || attribute == claimInEdit"
            [class.alert-danger]="newAttribute.name === attribute.name"
            [class.text-secondary]="isClaimCred(attribute)"
            *ngFor="let attribute of existingNonStandardClaims">
            <div class="col-sm">
              <i *ngIf="isClaimRequested(attribute)" class="fa fa-openid"></i><b> {{ attribute.name }}</b>
            </div>
            <div class="col-sm">
              <input *ngIf="!isClaimCred(attribute) && (attribute == claimInEdit)" placeholder="{{ getMessage('Value') }}" [(ngModel)]="attribute.value">
              <span *ngIf="!isClaimCred(attribute) && (attribute != claimInEdit)">{{ attribute.value }} <i class="text-secondary" style="float:right;"><i class="fa fa-certificate"></i> Self-issued</i></span>
              <span *ngIf="isClaimCred(attribute)"  >{{ getCredValue(attribute) }} <i class="text-primary" style="float:right;"><i class="fa fa-certificate"></i> {{ getIssuer(attribute) }}</i></span>
            </div>
            <div class="col-sm">
              <button class="btn btn-primary"  (click)="deleteAttribute(attribute)">
                <span class="fa fa-trash"></span>
              </button>
              <button class="ml-1 btn btn-primary" (click)="editAttribute(attribute)" *ngIf="!isClaimCred(attribute) && (attribute != claimInEdit)">
                <span class="fa fa-edit"></span>
              </button>
            </div>
          </div>
          <!-- New Attribute -->

          <div class="row mb-3"
               [class.alert-danger]="isInConflict(newAttribute)">
            <div class="col-sm">
              <input [class.text-danger]="!attributeNameValid(newAttribute)" placeholder="{{ getMessage('edit_identity_html@attribute') }}" [(ngModel)]="newAttribute.name">
            </div>
            <div class="form-group col-sm" name="newAttribute">

              <div *ngIf="isExperimental()" name="newAttribute">
                <div class="form-check form-check-inline active">
                  <input class="form-check-input" type="radio" (click)="newAttribute.value=''" name="newAttribute" [(ngModel)]="newAttribute.flag" id="plain" value="0" checked>
                  <label class="form-check-label" for="plain">
                    {{ getMessage("edit_identity_html@plain") }}
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" (click)="newAttribute.value=''" name="newAttribute" [(ngModel)]="newAttribute.flag" id="credential" value="1">
                  <label class="form-check-label" for="credential">
                    {{ getMessage("edit_identity_html@credential") }}
                  </label>
                </div>
              </div>
              <input *ngIf="newAttribute.flag == '0'" placeholder="{{ getMessage('Value') }}" [class.text-danger]="!attributeValueValid(newAttribute)" [(ngModel)]="newAttribute.value">
              <select *ngIf="newAttribute.flag == '1' && hasCredentialSources()" class="custom-select"
                (change)="newAttribute.credential=$event.target.value; " >
                <option value="">{{ getMessage("edit_identity_html@selectSource") }}</option>
                <option *ngFor="let cred of credentials" value={{cred.id}}>
                {{cred.name}}
                </option>
              </select>
              <div *ngIf="newAttribute.flag == '1' && !hasCredentialSources()" class="alert alert-primary" role="alert">
                {{ getMessage("edit_identity_html@noCredentialSource") }}
              </div>

              <select class="custom-select"
                *ngIf="newAttribute.credential !== '' && newAttribute.flag == '1'" (change)="newAttribute.value=$event.target.value">
                <option value="" >{{ getMessage("edit_identity_html@selectClaim") }}</option>
                <option *ngFor="let claim of credentialValuesForClaim(newAttribute)" value={{claim.name}}>
                {{claim.value}} <i>({{claim.name}})</i>
                </option>
              </select>
            </div>
            <div class="col-sm">
              <button [disabled]="!canAddAttribute(newAttribute)" class="btn btn-primary"  (click)="addAttribute()">
                <span class="fa fa-save"></span>
              </button>
            </div>
          </div>
      </div>
    </div>
    <!-- Attribute creation warning -->
    <div *ngIf="!attributeNameValid(newAttribute) || !attributeValueValid(newAttribute)" class="alert alert-primary alert-dismissible fade show" role="alert">
      <span class="fa fa-warning"></span> {{ getMessage("Note") }}
      <ul>
        <li>{{ getMessage("edit_identity_html@note1") }}</li>
        <li>{{ getMessage("edit_identity_html@note2") }}</li>
        <li>{{ getMessage("edit_identity_html@note3") }}</li>
      </ul>
    </div>

    <hr/>

    <!-- Edit card buttons -->
    <div>
      <button class="btn btn-primary" (click)="saveIdentity()" [disabled]="!canSaveIdentity()">
        <span class="fa fa-save"></span> {{ getMessage("SaveAndBack") }}
      </button>
      <button *ngIf="!inOpenIdFlow()" class="btn btn-primary" [routerLink]="['/edit-authorizations', identity.name]" [style.float]="'right'">
        <span class="fa fa-openid"></span>
        {{ getMessage("edit_identity_html@manageAuths") }}
      </button>
      <button *ngIf="!inOpenIdFlow() && isExperimental()" class="btn btn-primary" [routerLink]="['/edit-credentials', identity.name]" [style.float]="'right'">
        <span class="fa fa-openid"></span>
        {{ getMessage("edit_identity_html@manageCreds") }}
      </button>
      <button *ngIf="!inOpenIdFlow() && isExperimental()" class="btn btn-primary" [routerLink]="['/import-attributes', identity.name ]" [style.float]="'right'">
        <span class="fa fa-download"></span> {{getMessage("edit_identity_html@linkAccount")}}
      </button>
    </div>
  </div>
</div>
