<!-- Identity edit screen -->
<div class="m-2 card">
  <div class="card-avatar card-img-top">
    <div class="card-avatar-character text-dark">
      Manage identity: <i>{{ identity.name }}</i>
    </div>
  </div>
  <!-- Attribute table -->
  <div class="card-body">
    <div>
      <h6 class="card-subtitle mb-2">Attributes:</h6>
      <!-- Missing references -->
      <table class="table pb-1" *ngIf="isReferenceMissing()">
        <thead>
          <tr>
              <th>Attribute Name</th>
              <th>Attribute Value</th>
              <th>Attestation ID</th>
          </tr>
        </thead>
        <tbody>
          <tr [class.openid]="inOpenIdFlow()" [class.alert-danger]="newReference.name === missing.name" class="text-primary" *ngFor="let missing of missingReferences">
            <td><div style="min-width: 15em">{{missing.name}}</div></td>
            <td>
<select *ngIf="missing.ref_id !== ''" (change)="missing.ref_value=$event.target.value">
                <option value="">Select a Claim</option>
                <option *ngFor="let claim of objectKeys(attestation_val[missing.ref_id])" value={{claim}}>
                  {{claim}}
                </option>
                <option value="">{{attestationValues[missing.ref_id]['iss']}}</option>
              </select>
            </td>
            <td>
              <select (change)="missing.ref_id=$event.target.value; ">
              <option value="">Select an Attestation</option>
              <option *ngFor="let attest of attestations" value={{attest.id}}>
                {{attest.name}}
              </option>
            </select>
            </td>
            <td>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- Missing attributes -->
      <table class="table pb-1" *ngIf="isAttributeMissing()">
        <thead>
          <tr>
              <th>Attribute Name</th>
              <th>Attribute Value</th>
          </tr>
        </thead>
        <tbody>
          <tr [class.openid]="inOpenIdFlow()" [class.alert-danger]="newAttribute.name === missing.name" class="text-primary" *ngFor="let missing of missingAttributes">
            <td><div style="min-width: 15em">{{missing.name}}</div></td>
            <td>
              <input placeholder="Value" [(ngModel)]="missing.value">
            </td>
            <td>
            </td>
          </tr>
        </tbody>
      </table>
      <!-- Requested attributes -->
      <table class="table pb-1" style="">
        <thead *ngIf="!isAttributeMissing()">
          <tr>
              <th>Attribute Name</th>
              <th>Attribute Value</th>
          </tr>
        </thead>
        <tbody>
          <tr [class.openid]="inOpenIdFlow()" [class.text-primary]="isRequested(attribute)" [class.alert-danger]="newAttribute.name === attribute.name" [class.text-secondary]="isAttestation(attribute)" *ngFor="let attribute of attributes">
            <td><div style="min-width: 15em">{{ attribute.name }}</div></td>
            <td>
              <input *ngIf="!isAttestation(attribute)" placeholder="Value" [(ngModel)]="attribute.value">
              <span *ngIf="isAttestation(attribute)" >{{ attribute.value }} issued by {{ getIssuer(attribute) }} as ``{{ getReferencedName(attribute) }}''</span>
            </td>
            <td>
              <button class="btn btn-primary" (click)="deleteAttribute(attribute)" *ngIf="!isAttestation(attribute)">
                <span class="fa fa-trash"></span>
              </button>
              <button class="btn btn-primary"  (click)="deleteReferenceByAttribute(attribute)" *ngIf="isAttestation(attribute)">
                <span class="fa fa-trash"></span>
              </button>
            </td>
          </tr>
          <tr [class.alert-danger]="isInConflict(newAttribute)">
            <td>
              <input [class.text-danger]="!attributeNameValid(newAttribute)" placeholder="Attribute" [(ngModel)]="newAttribute.name">
            </td>
            <td>
              <input placeholder="Value" [class.text-danger]="!attributeValueValid(newAttribute)" [(ngModel)]="newAttribute.value">
            </td>
            <td>
              <button [disabled]="!canAddAttribute(newAttribute)" class="btn btn-primary"  (click)="addAttribute()">
                <span class="fa fa-plus"></span> 
              </button>
            </td>
          </tr>
          <tr [class.alert-danger]="isRefInConflict(newReference)">
            <td>
              <input [class.text-danger]="!referenceNameValid(newReference)" placeholder="Reference" [(ngModel)]="newReference.name">
            </td>
            <td>
              <select (change)="newReference.ref_id=$event.target.value; ">
                <option value="">Attestation</option>
                <option *ngFor="let attest of attestations" value={{attest.id}}>
                {{attest.name}}
                </option>
              </select>

              <select *ngIf="newReference.ref_id !== ''" (change)="newReference.ref_value=$event.target.value">
                <option value="">Source</option>
                <option *ngFor="let claim of attestationValuesForReference(newReference)" value={{claim}}>
                  {{claim}}
                </option>
                <option value="">{{attestationValues[newReference.ref_id]['iss']}}</option>
              </select>

            </td>

            <td>
              <button [disabled]="!canAddReference(newReference)" class="btn btn-primary"  (click)="addReference(newReference)">
                <span class="fa fa-plus"></span> 
              </button>
            </td>
          </tr>

        </tbody>
      </table>
    </div>
    <!-- Attribute creation warning -->
    <div *ngIf="!attributeNameValid(newAttribute) || !attributeValueValid(newAttribute)" class="alert alert-primary alert-dismissible fade show" role="alert">
      <span class="fa fa-warning"></span> Note:
      <ul>
        <li>Only use alphanumeric attribute names.</li>
        <li>You cannot define the same name twice.</li>
        <li>Attribute values may not be empty!</li>
      </ul>
    </div>
    <!-- optional attributes information -->
    <div *ngIf="optionalReferences.length !== 0" class="text-primary">
      <span class="fa fa-openid"></span> Optionally requested is also:
      <ul>
        <li *ngFor="let reference of optionalReferences"><strong>{{reference}}</strong>
      </ul>
    </div>
    <!-- Reference creation warning -->
    <div *ngIf="!referenceNameValid(newReference) || !referenceValueValid(newReference) || !referenceIDValid(newReference)" class="alert alert-primary alert-dismissible fade show" role="alert">
      <span class="fa fa-warning"></span> Note:
      <ul>
        <li>Only use alphanumeric reference names.</li>
        <li>You cannot define the same name twice.</li>
        <li>IDs and values may not be empty!</li>
      </ul>
    </div>

    <!-- Edit card buttons -->
    <div>
      <button class="btn btn-primary" (click)="saveIdentity()" [disabled]="!canSaveIdentity()">
        <span class="fa fa-save"></span> Save and Back
      </button>
      <button *ngIf="!inOpenIdFlow()" class="btn btn-primary" [routerLink]="['/edit-authorizations', identity.name]" [style.float]="'right'">
        <span class="fa fa-openid"></span>
        Manage authorizations
      </button>
      <button *ngIf="!inOpenIdFlow()" class="btn btn-primary" [routerLink]="['/edit-attestations', identity.name]" [style.float]="'right'">
        <span class="fa fa-openid"></span>
        Manage attestations
      </button>

    </div>
  </div>
</div>

